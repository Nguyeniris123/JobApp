rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Improved chat room access rules
    match /chatRooms/{roomId} {
      // Allow any authenticated user to create chat rooms
      allow create: if request.auth != null;
      
      // Allow read/update/delete if user is a participant in the chat
      allow read, update, delete: if 
        request.auth != null && (
          resource.data.recruiterId == request.auth.uid || 
          resource.data.candidateId == request.auth.uid
        );
      
      // Alternative more permissive rule if the above doesn't work
      // This allows any authenticated user to read/write chat rooms
      // Useful for debugging - remove in production
      allow read, write: if request.auth != null;
      
      match /messages/{messageId} {
        // Allow reading messages if user is part of the chat room
        allow read: if 
          request.auth != null && get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants.hasAny([request.auth.uid]);
        
        // Allow creating messages if sender ID matches auth user ID
        allow create, update: if 
          request.auth != null && request.resource.data.senderId == request.auth.uid;
        
        // Alternative more permissive rule for debugging
        allow read, write: if request.auth != null;
      }
    }
    
    // Test collection for checking connectivity
    match /test_collection/{document=**} {
      allow read, write: if true;
    }
    
    // Example of more secure rules for future implementation
    // match /chatRooms/{roomId} {
    //   // Allow operations if user ID is in participants array
    //   allow create: if request.resource.data.participants.hasAny([request.resource.data.recruiterId, request.resource.data.candidateId]);
    //   allow read, update: if resource.data.participants.hasAny([request.resource.data.recruiterId, request.resource.data.candidateId]);
    //   
    //   match /messages/{messageId} {
    //     allow read: if get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants.hasAny([request.resource.data.senderId]);
    //     allow create: if request.resource.data.senderId == request.auth.uid;
    //   }
    // }
  }
}
